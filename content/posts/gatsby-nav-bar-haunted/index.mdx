---
title: "Gatsby Nav Bar Haunted: Fixing a Stuck Dropdown"
date: "2025-02-02"
slug: "/gatsby-nav-bar-haunted"
tags: ["gatsby", "react", "debugging"]
description: "A precise fix for a dropdown that stays open in a Gatsby navigation menu."
theme: "Debugging"
---

My nav dropdown stayed open even when it should have closed.

This post shows the exact fix: a click outside handler and a visibility reset.

You will add two small effects and verify the menu closes correctly.

These steps are verifiable in this repo.

## The promise

By the end, you will:

- add a click outside handler for the menu
- close the dropdown when the nav hides
- verify the fix in the browser

> "If the menu stays open after you click outside, it is your state logic."

## What this is

**High level:** A dropdown should close when the user clicks elsewhere or when the nav hides.

**Low level:** You track open state in React and reset it in event handlers.

**Key terms:**

- **Dropdown state:** A boolean that says the menu is open or closed.
- **Click outside handler:** A document listener that closes the menu when you click away.

## What you need

- This repo
- A running dev server
- The navigation component open in your editor

## Start to Finish

### Step 1: Add a click outside handler
Goal:
Close the dropdown when a user clicks outside of it.

Actions:
- File path: `src/@lekoarts/gatsby-theme-minimal-blog/components/navigation.tsx`
- Add or confirm this effect exists:
  ```tsx
  const dropdownRef = React.useRef<HTMLLIElement>(null);

  React.useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);
  ```
- Make sure the dropdown container uses the ref:
  ```tsx
  <li ref={dropdownRef}>
  ```

Why:
React state does not update itself when users click away. A document listener lets you detect clicks outside the dropdown. This is the standard fix for stuck menus. Without it, the open state stays true and the menu never closes.

Verify:
- Run:
  ```bash
  bun run dev
  ```
- Open the dropdown and click anywhere else.
- Expected: the dropdown closes.
- This confirms the click outside handler works.

If it fails:
- Symptom: dropdown never closes.
- Fix: ensure the ref is attached to the correct element.

### Step 2: Reset when the nav hides
Goal:
Close the dropdown if the nav is hidden or collapsed.

Actions:
- File path: `src/@lekoarts/gatsby-theme-minimal-blog/components/navigation.tsx`
- Add or confirm this effect exists:
  ```tsx
  React.useEffect(() => {
    if (!isVisible) {
      setDropdownOpen(false);
    }
  }, [isVisible]);
  ```

Why:
A hidden nav should not keep its dropdown state. If the nav is collapsed, the dropdown should be closed. Resetting state when visibility changes prevents ghost menus. This also prevents focus traps in hidden menus.

Verify:
- Hide the nav (for example, collapse the menu on mobile).
- Expected: dropdown state resets and stays closed.
- This confirms the visibility reset works.

If it fails:
- Symptom: menu stays open when collapsed.
- Fix: ensure `isVisible` changes are passed correctly to the component.

## Verify it worked

- Dropdown closes on outside click.
- Dropdown closes when nav is hidden.
- No console errors appear.

## Common mistakes

- **Symptom:** Outside click does nothing.  
  **Cause:** The ref is attached to the wrong element.  
  **Fix:** Attach the ref to the dropdown container element.

- **Symptom:** Dropdown closes immediately after opening.  
  **Cause:** The click handler captures the opening click.  
  **Fix:** Use `mousedown` and ensure the button is inside the ref container.

- **Symptom:** Dropdown state gets out of sync.  
  **Cause:** Multiple state sources.  
  **Fix:** Keep one boolean state for open and close.

## Cheat sheet

- Track dropdown state in React.
- Close it on outside click.
- Reset state when nav hides.
- Verify in the browser.

## Next steps

- Add keyboard support for Escape to close.
- Add focus management for accessibility.

## Related links

- https://react.dev/reference/react/useEffect

## Final CTA

Fix the close behavior first. Fancy styling can wait.
